# Требования к системе Workspace с Drag-and-Drop

## Обзор

Система workspace должна поддерживать множественные рабочие области, которые могут отображаться одновременно на экране (аналогично Adobe Premiere), с возможностью перетаскивания элементов между ними.

## Типы Workspace

Предполагаемые workspace:

1. **Плейлист** - основная рабочая область для создания плейлистов
2. **Панель черновиков** - временное хранилище для отложенных треков
3. **Браузер для набора треков** - поиск и выбор треков из файловой системы
4. **База данных треков** - база данных с поиском и фильтрацией
5. **Настройка правил для плейлистов** - конфигурация правил генерации
6. **Инструменты автогенерации плейлистов** - автоматическая генерация плейлистов
7. **Плеер** - воспроизведение треков
8. Другие (будут добавляться в будущем)

## Функциональные требования

### 1. Отображение и Layout

- **Множественное отображение**: Workspace могут отображаться одновременно на экране
- **Перемещение и ресайз**: Workspace можно перемещать и изменять размер в UI (drag-and-drop панелей, ресайз)
- **Сохранение layout**: Layout и состояние workspace должны сохраняться между сессиями (в будущем)

### 2. Управление данными

- **Одновременное присутствие**: Один трек может находиться в нескольких workspace одновременно
- **Перемещение по умолчанию**: При перетаскивании трека между workspace выполняется перемещение (удаление из источника)
- **Копирование с модификатором**: Поддержка Ctrl+Drag для копирования вместо перемещения
- **Множественный выбор**: Поддержка перетаскивания нескольких треков одновременно
- **Независимое выделение**: Каждый workspace имеет собственное состояние выбранных элементов (selectedTrackIds)

### 3. История операций

- **Общая история**: Единая история операций (undo/redo) для всех workspace

### 4. Архитектура State Management

- **Изолированные stores**: Каждый workspace имеет собственный store в Zustand для максимальной изоляции
- **Общие stores**: Общие stores необходимы для взаимодействий между workspace
- **Глобальный менеджер**: Глобальный store для управления всеми workspace (список, активный, layout) в uiStore

### 5. Drag-and-Drop функциональность

- **Единый менеджер**: Один глобальный менеджер drag-and-drop для всех workspace
- **Специфичные хуки**: Каждый workspace имеет собственный хук (например, usePlaylistDragAndDrop)
- **Единый API**: Единый API для операций drag-and-drop для всех типов workspace
- **Валидация**: Поддержка валидации при перетаскивании (например, нельзя перетащить трек в настройки)
- **Файлы из ОС**: Поддержка перетаскивания файлов из файловой системы напрямую в любой workspace
- **Папки/директории**: Поддержка перетаскивания папок из FileBrowser в поддерживающие workspace
- **В начало/конец**: Поддержка операций "перетащить в начало/конец" для поддерживающих workspace

### 6. Типы данных

- **Разные типы контента**: Workspace могут иметь разные типы данных:
  - Плейлист: `Track[]`
  - Черновики: `Track[]`
  - База данных: `Track[]`
  - Настройки: `Rules[]`
  - И другие типы
- **Перетаскивание папок**: Перетаскивание папок/директорий считается валидной операцией между workspace

### 7. Идентификация

- **Уникальные ID**: Каждый workspace имеет уникальный идентификатор (UUID)
- **Динамическое создание**: Поддержка создания/удаления workspace динамически во время работы приложения

### 8. Ограничения

- **Разные ограничения**: Workspace могут иметь разные ограничения:
  - Плейлист: `MAX_PLAYLIST_SIZE = 150`
  - Черновики: без ограничений
  - И другие ограничения для других типов

### 9. Настройки отображения

- **Собственные настройки**: Каждый workspace может иметь собственные настройки отображения (сортировка, фильтры, группировка) для поддерживающих типов
- **Единый стиль**: Единый визуальный стиль/тема для всех workspace

### 10. Ограничения и исключения

- **Нет визуальных индикаторов**: Визуальные индикаторы при drag-and-drop не требуются (подсветка зоны drop, анимации)
- **Нет multi-window**: Поддержка multi-window не планируется
- **Нет cut/paste**: Операции "вырезать/вставить" через буфер обмена не требуются
- **Нет метаданных**: Перетаскивание метаданных или правил между workspace не требуется
- **Нет разных типов контента**: Перетаскивание между workspace с разными типами контента (например, трек в настройки) не требуется

## Технические требования

### Архитектура

1. **Глобальный менеджер workspace**
   - Хранение списка всех workspace
   - Управление активным workspace
   - Управление layout (позиция, размер)
   - Сохранение/загрузка layout

2. **Изолированные stores для каждого workspace**
   - Собственное состояние данных
   - Собственное состояние выделения
   - Собственные методы работы с данными

3. **Общие stores для взаимодействия**
   - Глобальный менеджер drag-and-drop
   - Общая история операций
   - Общие утилиты

4. **Единый API drag-and-drop**
   - Унифицированный интерфейс для всех типов workspace
   - Поддержка валидации операций
   - Поддержка move и copy операций

### Типы данных

```typescript
// Идентификация workspace
type WorkspaceId = string; // UUID

// Типы workspace
type WorkspaceType =
  | 'playlist'
  | 'drafts'
  | 'fileBrowser'
  | 'database'
  | 'rules'
  | 'autogenerator'
  | 'player'
  | string; // для будущих типов

// Контекст drop операции
interface DropContext {
  module: DropModule;
  targetId?: string;
  workspaceId: WorkspaceId; // Идентификатор целевого workspace
}

// Состояние перетаскивания
type DraggedItems =
  | {
      type: 'tracks';
      ids: Set<string>;
      sourceWorkspaceId: WorkspaceId; // Идентификатор источника
    }
  | { type: 'files'; paths: string[] }
  | null;
```

### Операции drag-and-drop

1. **Определение источника и цели**
   - При `dragStart`: сохранение `sourceWorkspaceId`
   - При `drop`: сравнение `sourceWorkspaceId` и `targetWorkspaceId`

2. **Логика операций**
   - Если `sourceWorkspaceId === targetWorkspaceId`: операция внутри workspace
   - Если `sourceWorkspaceId !== targetWorkspaceId`: операция между workspace
   - Если `Ctrl+Drag`: копирование вместо перемещения

3. **Валидация**
   - Проверка возможности операции между типами workspace
   - Проверка ограничений целевого workspace
   - Проверка типов данных

## План реализации

### Этап 1: Базовая инфраструктура

- Создание глобального менеджера workspace
- Расширение типов для поддержки workspaceId
- Создание базового интерфейса для workspace stores

### Этап 2: Drag-and-Drop между workspace

- Модификация системы drag-and-drop для поддержки cross-workspace
- Реализация логики move/copy
- Добавление валидации операций

### Этап 3: UI для управления workspace

- Реализация перемещения и ресайза панелей
- Сохранение/загрузка layout
- Визуальное отображение множественных workspace

### Этап 4: Интеграция существующих компонентов

- Адаптация PlaylistView для работы с workspace
- Создание новых workspace компонентов
- Интеграция с существующими stores

## Примечания

- Система должна быть расширяемой для добавления новых типов workspace
- Приоритет на изоляцию данных между workspace
- Единый API для упрощения работы с разными типами workspace
- Поддержка как простых операций (move), так и расширенных (copy с модификатором)
