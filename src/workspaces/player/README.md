# Player Workspace Module

## Описание

Модуль Player предоставляет функционал для автоматического последовательного воспроизведения плейлистов с поддержкой группировки треков, настраиваемых пауз между треками, управления состоянием проигрывания и интеграции с демо-плеером. Плеер работает в двух режимах: **подготовка** и **активная сессия**.

## Структура модуля

```
workspaces/player/
├── PlayerView.tsx       # Основной компонент плеера
├── index.ts            # Регистрация модуля в реестре
├── README.md           # Документация модуля
└── REQUIREMENTS.md     # Детальные требования и спецификация
```

## Зависимости

### Core
- `@core/types/workspace` - WorkspaceId, WorkspaceType
- `@core/types/track` - Track

### Shared
- `@shared/stores/playerStore` - store плеера с состоянием воспроизведения
- `@shared/stores/demoPlayerStore` - интеграция с демо-плеером
- `@shared/stores/settingsStore` - настройки приложения
- `@shared/services/ipcService` - IPC коммуникация
- `@shared/services/playerService` - сохранение/загрузка данных плеера
- `@shared/utils` - утилиты (formatDuration, logger)

## Функциональность

### Основные возможности

1. **Два режима работы**
   - **Режим подготовки**: редактирование плейлиста, группировка треков, настройка параметров
   - **Режим активной сессии**: автоматическое воспроизведение треков по очереди

2. **Управление воспроизведением**
   - Автоматическое последовательное воспроизведение треков
   - Управление: Play/Pause, Stop, Next
   - Управление позицией воспроизведения через таймлайн (клик для перехода к нужной позиции)
   - Выбор аудиоустройства для вывода звука
   - Интеграция с демо-плеером (автоматическая остановка при конфликте устройств)

3. **Группировка треков**
   - Объединение соседних треков в группы
   - Вложенная группировка (группы внутри групп)
   - Настройки воспроизведения на уровне группы
   - Отключение групп и треков
   - Группы отображаются как треки с полной унификацией логики
   - У групп есть все иконки как у треков (перетаскивание, чекбокс выделения, настройки)
   - Драг анд дроп работает для групп и для треков, перетаскиваемых в группы
   - Визуальное отображение групп: смещение левого края трека и полоска слева
   - При выделении нескольких подряд идущих треков/групп появляется иконка для создания группы

4. **Настройки воспроизведения**
   - Время паузы между треками (в секундах)
   - Действие после трека: сплошное воспроизведение (сразу к следующему), пауза между треками (ожидание), пауза после трека (следующий на паузе)
   - Настройки по умолчанию, на уровне группы и на уровне трека
   - Иерархия настроек: трек > группа > большая группа > по умолчанию
   - Визуальные индикаторы настроек: иконки рядом с иконкой настроек для треков/групп с индивидуальными настройками

5. **История проигрывания**
   - Отслеживание проигранных треков в режиме сессии
   - Визуальное отображение неактивных (проигранных) треков
   - Защита от изменения неактивных треков в режиме сессии
   - Автоматический сброс истории при сбросе сессии

6. **Отсечки по времени**
   - Настраиваемые интервалы (15, 30, 60 минут)
   - В режиме сессии: реальное время достижения отсечки
   - В режиме подготовки: время с начала плейлиста
   - Учёт пауз между треками в расчётах
   - Плановое время окончания плейлиста (красная отсечка)

7. **Визуальные индикаторы**
   - Состояние треков: активный (до начала сессии), проигранный (неактивный), отключённый, текущий, недоступный
   - Визуальное выделение текущего проигрываемого трека
   - Красное выделение отключённых треков
   - Красная иконка предупреждения для недоступных треков
   - Отображение времени окончания плейлиста
   - Иконки настроек для треков и групп с индивидуальными настройками перехода к следующему треку

### Особенности реализации

- Использует отдельный `playerStore` для управления состоянием плеера
- Сохраняет данные плейлиста в отдельный JSON файл (`.player.json`) с возможностью сохранения и загрузки через кнопки в интерфейсе
- **Состояние сессии не сохраняется в файл** — хранится отдельно в persist middleware
- Модуль не зависит от плейлиста, но решения могут быть общими
- При загрузке файла все данные плейлиста полностью заменяются, состояние сессии сбрасывается (никаких слияний)
- Автоматически синхронизируется с демо-плеером при выборе одного устройства
- Сохраняет состояние сессии между перезапусками приложения (воспроизведение остаётся на паузе)
- Периодически проверяет доступность треков (каждые 30 секунд в режиме сессии)
- Обрабатывает ошибки с уведомлениями пользователя

## Использование

Модуль используется автоматически через `WorkspaceRenderer` для workspace с типом `'player'`. Плеер имеет собственный store и работает независимо от основного плейлиста, но может загружать треки из плейлиста.

### Управление режимами

- **Режим подготовки**: все кнопки управления (Play, Pause, Stop, Next) неактивны. Доступна кнопка для воспроизведения трека в демо-плеере.
- **Режим активной сессии**: все кнопки управления активны. Кнопка демо-плеера пропадает. Кнопка "Начать сессию" меняется на "Сбросить" и становится приглушённой.

## Layout

Плеер доступен через layout preset, который включает плеер и браузер файлов для удобной работы.

