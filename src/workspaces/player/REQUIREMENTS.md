# Player Workspace - Детальные требования

## 1. Общая архитектура

### 1.1 Режимы работы

Плеер имеет два режима работы:

- **Режим подготовки (Preparation Mode)**
  - Редактирование плейлиста
  - Группировка треков
  - Настройка параметров воспроизведения
  - Отключение/включение треков и групп
  - Все операции доступны

- **Режим активной сессии (Active Session Mode)**
  - Автоматическое воспроизведение треков
  - Отслеживание истории проигрывания
  - Неактивные (проигранные) треки защищены от изменений
  - Можно изменять только активные треки и группы

### 1.2 Переключение режимов

- Кнопка "Начать сессию" находится в информационной панели (верхняя часть интерфейса)
- Кнопка "Начать сессию" активна всегда, если есть активные треки
- Кнопка "Начать сессию" переключает из режима подготовки в режим сессии
- В режиме сессии кнопка "Начать сессию" меняется на "Сбросить" и становится приглушённой
- Кнопка "Сбросить" возвращает в режим подготовки и сбрасывает:
  - Историю проигрывания (все треки становятся активными)
  - Отключённые пометки (все треки и группы становятся активными)
  - Позицию воспроизведения
  - Останавливает текущее воспроизведение
- Настройки групп и треков (паузы, действия после трека) сохраняются при сбросе
- Сброс — единственный способ вернуться из режима сессии в режим подготовки

## 2. Структура данных

### 2.1 Формат сохранения плеера

Плеер сохраняется в отдельный JSON файл с расширением `.player.json`. Файл можно сохранять и загружать через кнопки в интерфейсе. При загрузке файла все текущие данные плейлиста сбрасываются и заменяются данными из файла (никаких слияний не происходит). **Состояние сессии не сохраняется в файле** — оно хранится отдельно в persist middleware и сбрасывается при загрузке нового файла.

Формат файла (только данные плейлиста, без состояния сессии):

```json
{
  "version": "1.0",
  "tracks": [...],
  "groups": [...],
  "settings": {
    "defaultPauseBetweenTracks": 0,
    "defaultActionAfterTrack": "next",
    "plannedEndTime": null
  }
}
```

**Важно:** Файл `.player.json` содержит только структуру плейлиста (треки, группы, настройки). Состояние сессии (текущий трек, история проигрывания, отключённые пометки) хранится отдельно и не сохраняется в файл.

**Структура группы:**
```json
{
  "id": "string",
  "name": "string" | null,
  "items": [...],  // Массив треков (по ID) и других групп
  "settings": {
    "pauseBetweenTracks": number | null,
    "actionAfterTrack": "next" | "pauseAndNext" | "pause" | null
  },
  "disabled": boolean
}
```

### 2.2 Группировка треков

**Структура группы:**
- Группы могут содержать треки и другие группы (вложенность)
- Группа имеет уникальный ID
- Группа может иметь настройки воспроизведения
- Группа может быть отключена
- **Группа отображается как трек** — к ней применима вся логика трека
- Группа имеет все те же иконки, что и трек:
  - Иконка перетаскивания (drag handle)
  - Чекбокс выделения
  - Кнопка настроек
  - Кнопка отключения (в режиме сессии)
  - Кнопка удаления (в режиме подготовки)

**Правила группировки:**
- В режиме подготовки можно объединять соседние треки в группы
- Можно объединять группы с треками в большие группы
- При выделении нескольких подряд идущих треков или групп появляется иконка для создания группы
- При нажатии на иконку создания группы выделенные элементы объединяются в новую группу
- В режиме сессии можно изменять группы, если все треки внутри активны
- Если часть треков в группе активна, а часть неактивна, группу можно редактировать (она отображается как активная)
- Если хотя бы один трек в группе неактивен, группу нельзя расформировать
- Если все треки в группе неактивны, группа помечается неактивной
- Если группа содержит только отключённые треки, она считается отключённой, но её можно редактировать
- Если в группе нет треков (все удалены), группа удаляется автоматически

**Драг анд дроп для групп:**
- Группы можно перетаскивать так же, как и треки
- Треки можно перетаскивать в группы (добавление в группу)
- Группы можно перетаскивать в другие группы (создание вложенных групп)
- При перетаскивании трека или группы на группу элемент добавляется внутрь целевой группы
- При перетаскивании на трек создаётся новая группа, содержащая оба элемента
- В режиме сессии заблокированные (проигранные или текущие) треки и группы нельзя перетаскивать

**Визуальное отображение групп:**
- Треки внутри группы визуально смещены вправо (небольшое смещение левого края)
- Слева от смещённых треков отображается вертикальная полоска (индикатор вложенности)
- Группа отображается как обычный трек с названием группы и количеством элементов
- Вложенные группы имеют дополнительное смещение и дополнительную полоску

### 2.3 Иерархия настроек

Настройки применяются в следующем порядке приоритета (от высшего к низшему):

1. **Настройки трека** (высший приоритет)
2. **Настройки группы** (средний приоритет)
3. **Настройки большей группы** (низкий приоритет)
4. **Настройки по умолчанию** (низший приоритет)

Если у трека нет индивидуальной настройки, используется настройка группы. Если у группы нет настройки, используется настройка большей группы. Если у большей группы нет настройки, используется настройка по умолчанию.

## 3. Настройки воспроизведения

### 3.1 Пауза между треками

- Настраивается в секундах (глобальная настройка)
- Применяется автоматически после каждого трека
- Учитывается в расчёте времени окончания плейлиста
- Учитывается в отсечках по времени

### 3.2 Действие после трека

В конце трека происходит следующее. Вызывается одна из опциональных логик:

1. **"Пауза после трека" (pause)**
   - Переходим к следующему треку и ставим его на паузу
   - Требуется ручное нажатие Play для продолжения воспроизведения следующего трека

2. **"Пауза между треками" (pauseAndNext)**
   - Ждём время, заданное пользователем (настройка "пауза между треками")
   - По истечению времени автоматически переходим к следующему треку
   - Если во время паузы нажать Play, сразу переходит к следующему треку
   - Если во время паузы нажать Pause, таймер сбрасывается и следующий трек не запускается
   - Пауза "пауза между треками" учитывается в расчёте времени окончания для каждого трека с таким действием (как дополнительное время к длительности трека)

3. **"Сплошное воспроизведение" (next)**
   - Просто переходим к следующему треку
   - Следующий трек сразу начинает играть (условно задержка 0)
   - Пауза между треками не применяется

### 3.3 Настройка по умолчанию

- Глобальная настройка для всех треков
- Может быть переопределена на уровне группы или трека
- Сохраняется в настройках плеера

## 4. Состояния треков

### 4.1 Типы состояний

1. **Активный (Active)**
   - Трек готов к воспроизведению
   - Доступен в режиме подготовки и сессии
   - Можно редактировать, перемещать, удалять

2. **Неактивный (Inactive/Played)**
   - Трек был проигран в текущей сессии
   - Отображается визуально неактивным
   - Нельзя удалить или изменить в режиме сессии
   - Можно изменить только в режиме подготовки после сброса сессии

3. **Отключённый (Disabled)**
   - Трек пропускается при воспроизведении
   - Визуально выделяется красным цветом
   - Можно отключить/включить в обоих режимах
   - При пропуске помечается неактивным
   - При сбросе сессии становится активным

4. **Текущий (Current)**
   - Трек, который сейчас воспроизводится
   - Визуально выделяется специальным индикатором
   - В режиме сессии

### 4.2 Визуальное отображение

- **Активные треки**: обычное отображение
- **Неактивные треки**: приглушённый цвет
- **Отключённые треки**: красное выделение (граница)
- **Текущий трек**: специальный индикатор (граница)

## 5. Управление воспроизведением

### 5.1 Кнопки управления

1. **Play**
   - В режиме подготовки: кнопка неактивна (сессия должна быть начата кнопкой "Начать сессию")
   - В режиме сессии: начинает/продолжает воспроизведение
   - Если трек на паузе, продолжает с места паузы

2. **Pause**
   - В режиме подготовки: кнопка неактивна
   - В режиме сессии: ставит воспроизведение на паузу
   - Сохраняет позицию в текущем треке
   - Сессия продолжается
   - Если во время паузы "пауза и перейти" нажать Pause, таймер сбрасывается и следующий трек не запускается

3. **Stop**
   - В режиме подготовки: кнопка неактивна
   - В режиме сессии: останавливает воспроизведение
   - Сбрасывает позицию в текущем треке
   - Сессия не останавливается (можно снова нажать Play)

4. **Next**
   - В режиме подготовки: кнопка неактивна
   - В режиме сессии: текущий трек помечается как проигранный (неактивный)
   - Сразу переходит к следующему активному треку
   - Пауза между треками НЕ применяется
   - Если следующего трека нет, останавливается
   - Можно использовать для перехода к следующему треку при ошибке загрузки текущего

### 5.2 Автоматическое воспроизведение

- После окончания трека применяется настройка "действие после трека"
- Если выбрано "сплошное воспроизведение" (next), сразу переходим к следующему треку без задержки
- Если выбрано "пауза между треками" (pauseAndNext), происходит пауза на заданное время, затем автоматически запускается следующий трек
- Если выбрано "пауза после трека" (pause), переходим к следующему треку и ставим его на паузу
- Отключённые треки пропускаются автоматически и помечаются неактивными. "действие после трека" таких треков не применяется

### 5.3 Управление позицией воспроизведения (таймлайн)

- У каждого трека есть таймлайн (визуальное отображение прогресса воспроизведения)
- Пользователь может кликнуть на таймлайн трека, чтобы перенести точку воспроизведения
- При клике на таймлайн:
  - Позиция воспроизведения устанавливается в соответствующее место трека
  - Если трек воспроизводится, воспроизведение продолжается с новой позиции
  - Если трек на паузе, позиция сохраняется и воспроизведение начнётся с новой позиции при нажатии Play
- Доступно как в режиме подготовки (для предпросмотра), так и в режиме сессии (для управления текущим треком)

## 6. Выбор аудиоустройства

### 6.1 Получение списка устройств

- Используется Web Audio API: `navigator.mediaDevices.enumerateDevices()`
- Фильтрация по типу 'audiooutput'
- Отображение списка доступных устройств в настройках плеера

### 6.2 Интеграция с демо-плеером

- Демо-плеер — это общий компонент приложения, расположенный в AppHeader
- В режиме подготовки в интерфейсе плеера есть кнопка для воспроизведения трека в демо-плеере
- В режиме сессии кнопка демо-плеера в интерфейсе плеера пропадает
- Если плеер выберет устройство, на котором уже играет демо-плеер:
  - Демо-плеер автоматически останавливает воспроизведение сразу
  - Демо-плеер становится неактивным (кнопки отключены)
  - Демо-плеер не воспроизводит звук, пока используется то же устройство
- Если демо-плеер выбран на то же устройство, что и плеер, но демо-плеер на паузе:
  - Демо-плеер становится неактивным
- Если устройства разные:
  - Оба плеера могут работать одновременно
  - Демо-плеер активен и может воспроизводить
- При смене устройства во время воспроизведения:
  - Воспроизведение продолжается на новом устройстве

## 7. Отсечки по времени

### 7.1 Настройка интервалов

- Настраиваемые интервалы: 15, 30, 60 минут
- Пользователь может выбрать интервал или отключить отсечки
- Отсечки настраиваются теми же настройками, что и в плейлисте (используются настройки из `settingsStore`)
- Отсечки отображаются так же, как и в плейлисте (визуальные маркеры в списке треков)

### 7.2 Режим сессии

- Отсечки показывают **реальное время** (например, "15:30")
- Расчёт учитывает:
  - Длительность всех треков до этой точки
  - Паузы между треками
  - Отключённые треки не учитываются
  - Текущее время начала сессии

### 7.3 Режим подготовки

- Отсечки показывают **время с начала плейлиста** (как в обычном плейлисте)
- Формат: "H:MM" или "M:SS"
- Расчёт учитывает:
  - Длительность всех треков до этой точки
  - Паузы между треками
  - Отключённые треки не учитываются

### 7.4 Время окончания плейлиста и плановое время окончания

**Расчёт времени окончания:**

Время окончания рассчитывается с учётом:

- Длительности всех активных треков
- Пауз между треками (для каждого трека)
- Пауз "пауза и перейти" (если настроены)
- Отключённые треки НЕ учитываются

**Плановое время окончания:**

- Пользователь может установить плановое время окончания плейлиста (время, к которому пользователь хочет закончить плейлист, например, конец мероприятия)
- Отображается как красная отсечка в месте окончания плейлиста (в списке треков)
- Показывает время окончания плейлиста в месте окончания
- Пользователь сам поймёт, что следующие треки не влезли по времени
- Отображается в информационной панели (верхняя часть интерфейса)
- Формат: реальное время (например, "18:45")
- Обновляется динамически при изменении настроек
- Показывается как в режиме подготовки, так и в режиме сессии

## 8. История проигрывания

### 8.1 Отслеживание

- В режиме сессии отслеживаются все проигранные треки
- Трек помечается как проигранный когда:
  - Воспроизведение трека завершилось естественным образом
  - Был нажат Next
  - Трек был пропущен (отключён)

### 8.2 Сохранение

- История сохраняется в состоянии сессии
- Сохраняется между перезапусками приложения
- Стирается при сбросе сессии

### 8.3 Защита от изменений

- Неактивные (проигранные) треки и группы нельзя:
  - Удалить
  - Переместить (drag and drop)
  - Изменить настройки
  - Объединить/разъединить в группах
  - Перетаскивать на них другие элементы

- Текущий трек или группа с текущим треком в режиме сессии также защищены от изменений:
  - Нельзя удалить
  - Нельзя переместить
  - Нельзя изменить настройки
  - Нельзя перетаскивать на них другие элементы

- Можно изменить только в режиме подготовки после сброса сессии

## 9. Группы и отключение

### 9.1 Отключение треков

- Трек можно отключить в любом режиме
- Отключённый трек визуально выделяется красным
- При воспроизведении отключённый трек пропускается
- При пропуске трек помечается неактивным
- При сбросе сессии отключённый трек становится активным

### 9.2 Отключение групп

- Группу можно отключить в любом режиме
- При отключении группы:
  - Все треки внутри группы отключаются
  - Все подгруппы внутри группы отключаются
  - Рекурсивное отключение всех вложенных элементов

- Группа помечается неактивной если:
  - Все треки внутри группы неактивны (проиграны)
  - Все подгруппы внутри группы неактивны

### 9.3 Изменение групп в режиме сессии

- Группы работают по той же логике, что и треки
- Можно изменять группы только если все треки внутри активны
- Если хотя бы один трек в группе неактивен, группу нельзя:
  - Расформировать
  - Изменить настройки
  - Переместить (drag and drop)
  - Перетаскивать на неё другие элементы
- Группа с текущим треком защищена от изменений так же, как и текущий трек
- Группы имеют все те же иконки и функции, что и треки (перетаскивание, чекбокс, настройки, отключение, удаление)

## 10. Сохранение и загрузка

### 10.1 Сохранение данных плеера

- Данные плейлиста сохраняются в отдельный файл `.player.json` через кнопку в интерфейсе
- Сохраняется структура плейлиста: треки, группы, настройки
- **Состояние сессии НЕ сохраняется в файл** — оно хранится отдельно
- Формат: JSON с версионированием

### 10.2 Загрузка файла плеера

- Можно загрузить файл `.player.json` через кнопку в интерфейсе
- При загрузке файла:
  - Все текущие данные плейлиста сбрасываются и заменяются данными из файла
  - **Состояние сессии сбрасывается** (переход в режим подготовки, очистка истории, сброс отключённых пометок)
  - Никаких слияний не происходит — полная замена данных
- Если в загруженном файле есть группы, но некоторые треки из этих групп отсутствуют в текущем плейлисте:
  - Группы, в которых нет треков, удаляются автоматически
- После загрузки файла можно начать новую сессию

**Юз кейс:**
1. Загружаем файл `.player.json` — загружаются только данные плейлиста (треки, группы, настройки)
2. Запускаем сессию — состояние сессии создаётся в памяти/store
3. Если загружаем новый файл — всё сбрасывается, загружается новый плейлист, можно начать новую сессию

### 10.3 Сохранение состояния сессии

- Состояние сессии **НЕ сохраняется в файл `.player.json`**
- Состояние сессии хранится отдельно (в persist middleware или в памяти):
  - Текущий трек
  - Позиция в текущем треке
  - История проигранных треков
  - Отключённые треки и группы
  - Режим (подготовка/сессия)
- Состояние сессии сохраняется между перезапусками приложения
- При перезапуске приложения воспроизведение остаётся на паузе
- Пользователь должен вручную нажать Play, чтобы продолжить воспроизведение
- При загрузке нового файла `.player.json` состояние сессии сбрасывается

## 11. Интерфейс

### 11.1 Расположение элементов

Интерфейс плеера имеет следующую структуру:

1. **Информационная панель (верхняя часть)**
   - Кнопка "Начать сессию" / "Сбросить"
   - Время окончания плейлиста (реальное время)
   - Текущий трек
   - Позиция в текущем треке
   - Общая статистика (количество треков, общее время — как в плейлисте)
   - Кнопки сохранения и загрузки файла `.player.json`
   - Настройки:
     - Пауза между треками
     - Действие после трека (по умолчанию)
     - Интервал отсечек
     - Плановое время окончания
     - Выбор аудиоустройства
   - В режиме подготовки: кнопка для воспроизведения трека в демо-плеере
   - В режиме сессии: кнопка демо-плеера пропадает
   - **Иконка создания группы**: появляется в заголовке при выделении нескольких подряд идущих треков или групп (только в режиме подготовки)

2. **Список треков (средняя часть)**
   - Отображение треков с визуальными индикаторами состояний
   - Отображение групп как треков с полной унификацией логики
   - Отсечки по времени
   - Группировка с визуальным выделением (смещение и полоска слева)
   - Настройки для каждого трека/группы
   - Все иконки для групп (перетаскивание, чекбокс, настройки, отключение, удаление)

3. **Панель управления (нижняя часть)**
   - Кнопки: Play, Pause, Stop, Next
     - В режиме подготовки: все кнопки неактивны
     - В режиме сессии: все кнопки активны
   - Индикатор текущего режима

### 11.2 Визуальные индикаторы

- **Активный трек**: обычное отображение
- **Неактивный трек**: приглушённый цвет, возможно перечёркивание
- **Отключённый трек**: красное выделение
- **Текущий трек**: специальный индикатор (анимация, другой цвет)
- **Недоступный трек**: заметная красная иконка предупреждения (трек не найден по пути)
- **Группа**: отображается как трек со всеми иконками (перетаскивание, чекбокс, настройки)
- **Треки внутри группы**: смещены вправо с вертикальной полоской слева (индикатор вложенности)
- **Вложенные группы**: дополнительное смещение и дополнительная полоска
- **Неактивная группа**: приглушённый цвет всей группы
- **Группа с активными и неактивными треками**: отображается как активная
- **Иконка создания группы**: появляется в заголовке при выделении нескольких подряд идущих треков/групп

### 11.3 Иконки настроек

- У каждого трека и группы есть иконка настроек
- Иконка настроек позволяет открыть панель настроек для трека/группы
- Если у трека или группы настроено нестандартное поведение перехода к следующему треку (отличающееся от настроек по умолчанию), рядом с иконкой настроек появляется одна из трёх иконок:
  - Иконка "пауза после трека" — если настроено действие "pause"
  - Иконка "пауза между треками" — если настроено действие "pauseAndNext"
  - Иконка "сплошное воспроизведение" — если настроено действие "next" (и отличается от настроек по умолчанию)
- Иконки помогают быстро визуально определить, какие треки/группы имеют индивидуальные настройки перехода

## 12. Обработка ошибок и проверка треков

### 12.1 Проверка доступности треков

- В режиме сессии периодически (каждые 30 секунд) проверяется наличие всех треков по пути
- Если трек недоступен, ставится пометка об опасности (заметная красная иконка)
- Если трек стал недоступен во время воспроизведения, воспроизведение останавливается
- Можно вручную перейти к следующему треку (Next) при ошибке загрузки

### 12.2 Обработка ошибок

- **Ошибка загрузки трека**: воспроизведение останавливается, показывается уведомление об ошибке
- **Недоступность аудиоустройства**: воспроизведение ставится на паузу, показывается уведомление, затем выбирается устройство воспроизведения по умолчанию системы
- **Ошибка загрузки `.player.json`**: показывается уведомление с ошибкой, используются настройки по умолчанию
- **Пустой плейлист**: нельзя начать сессию (кнопка "Начать сессию" неактивна)
- **Все треки отключены**: нельзя начать сессию (кнопка "Начать сессию" неактивна)

### 12.3 Защита от отключения текущего трека

- Текущий трек нельзя отключить
- Если попытаться отключить группу, содержащую текущий трек, группа не отключается

## 13. Layout

### 13.1 Layout preset

Добавить новый layout preset, который включает:
- Плеер workspace
- Браузер файлов workspace

Это позволит удобно работать с плеером и добавлять треки из файловой системы.

## 14. Интеграция с системой

### 14.1 Регистрация workspace

- Плеер регистрируется как workspace типа `'player'`
- Имеет собственный уникальный ID
- Интегрируется в систему layout через `WorkspaceRenderer`

### 14.2 Store плеера

- Отдельный Zustand store для управления состоянием плеера
- Не зависит от `playlistStore`
- Модуль не должен зависеть от плейлиста, но решения могут быть общими
- Может загружать треки из плейлиста, но хранит их отдельно
- Сохраняет состояние через persist middleware или через `playerService`

### 14.3 Сервисы

- `playerService` - сохранение/загрузка данных плеера
- Интеграция с `ipcService` для работы с файловой системой
- Интеграция с `demoPlayerStore` для синхронизации устройств

